# è®°ä¸ªå¤§æ¦‚ - æŠ€æœ¯æ¶æ„æ–‡æ¡£

## 1. Architecture design

```mermaid
graph TD
  A[ç”¨æˆ·æµè§ˆå™¨] --> B[Vue.js å‰ç«¯åº”ç”¨]
  B --> C[è¯­éŸ³è¯†åˆ« API]
  B --> D[æœ¬åœ°å­˜å‚¨ LocalStorage]
  B --> E[Supabase æœåŠ¡]
  E --> F[PostgreSQL æ•°æ®åº“]
  E --> G[ç”¨æˆ·è®¤è¯]
  
  subgraph "å‰ç«¯å±‚"
    B
  end
  
  subgraph "å¤–éƒ¨æœåŠ¡"
    C
  end
  
  subgraph "æ•°æ®å±‚ (Supabase)"
    E
    F
    G
  end
  
  subgraph "æœ¬åœ°å­˜å‚¨"
    D
  end
```

## 2. Technology Description

* **å‰ç«¯**: Vue.js\@3 + Vite + Tailwind CSS + Pinia

* **åç«¯**: Supabase (æä¾›æ•°æ®åº“ã€è®¤è¯ã€å®æ—¶åŒæ­¥)

* **è¯­éŸ³è¯†åˆ«**: Web Speech API (æµè§ˆå™¨åŸç”Ÿ) + ç™¾åº¦è¯­éŸ³è¯†åˆ«API (å¤‡é€‰)

* **å›¾è¡¨åº“**: Chart.js

* **UIç»„ä»¶**: è‡ªå®šä¹‰ç»„ä»¶ + Headless UI

## 3. Route definitions

| Route       | Purpose          |
| ----------- | ---------------- |
| /           | é¦–é¡µï¼Œæ˜¾ç¤ºè¯­éŸ³è®°è´¦å…¥å£å’Œæ”¯å‡ºæ¦‚è§ˆ |
| /record     | æ‰‹åŠ¨è®°è´¦é¡µé¢ï¼Œé‡‘é¢è¾“å…¥å’Œåˆ†ç±»é€‰æ‹© |
| /statistics | ç»Ÿè®¡åˆ†æé¡µé¢ï¼Œæ”¯å‡ºè¶‹åŠ¿å’Œåˆ†ç±»ç»Ÿè®¡ |
| /budget     | é¢„ç®—ç®¡ç†é¡µé¢ï¼Œè®¾ç½®å’Œè·Ÿè¸ªé¢„ç®—   |
| /settings   | è®¾ç½®é¡µé¢ï¼Œåˆ†ç±»ç®¡ç†å’Œæ•°æ®å¯¼å‡º   |
| /login      | ç™»å½•é¡µé¢ï¼Œç”¨æˆ·è®¤è¯        |

## 4. API definitions

### 4.1 Core API

**è¯­éŸ³è¯†åˆ«ç›¸å…³**

```
POST /api/speech/recognize
```

Request:

| Param Name  | Param Type | isRequired | Description     |
| ----------- | ---------- | ---------- | --------------- |
| audio\_data | blob       | true       | å½•éŸ³æ•°æ®            |
| format      | string     | true       | éŸ³é¢‘æ ¼å¼ (webm/wav) |

Response:

| Param Name | Param Type | Description |
| ---------- | ---------- | ----------- |
| text       | string     | è¯†åˆ«å‡ºçš„æ–‡å­—å†…å®¹    |
| amount     | number     | æå–çš„é‡‘é¢       |
| category   | string     | æ¨æµ‹çš„åˆ†ç±»       |
| confidence | number     | è¯†åˆ«ç½®ä¿¡åº¦       |

Example:

```json
{
  "text": "ä»Šå¤©åƒé¥­ç”¨äº†50å—é’±",
  "amount": 50,
  "category": "é¤é¥®",
  "confidence": 0.95
}
```

**æ”¯å‡ºè®°å½•ç›¸å…³**

```
POST /api/expenses
GET /api/expenses
PUT /api/expenses/:id
DELETE /api/expenses/:id
```

**é¢„ç®—ç®¡ç†ç›¸å…³**

```
POST /api/budgets
GET /api/budgets
PUT /api/budgets/:id
```

## 5. Data model

### 5.1 Data model definition

```mermaid
erDiagram
  USERS ||--o{ EXPENSES : creates
  USERS ||--o{ BUDGETS : sets
  USERS ||--o{ CATEGORIES : customizes
  EXPENSES }o--|| CATEGORIES : belongs_to
  BUDGETS }o--|| CATEGORIES : applies_to

  USERS {
    uuid id PK
    string email
    string name
    timestamp created_at
    timestamp updated_at
  }
  
  EXPENSES {
    uuid id PK
    uuid user_id FK
    uuid category_id FK
    decimal amount
    string description
    date expense_date
    string source
    timestamp created_at
  }
  
  CATEGORIES {
    uuid id PK
    uuid user_id FK
    string name
    string icon
    string color
    boolean is_default
    timestamp created_at
  }
  
  BUDGETS {
    uuid id PK
    uuid user_id FK
    uuid category_id FK
    decimal amount
    string period_type
    date start_date
    date end_date
    timestamp created_at
  }
```

### 5.2 Data Definition Language

**ç”¨æˆ·è¡¨ (users)**

```sql
-- Supabase Auth è‡ªåŠ¨ç®¡ç†ç”¨æˆ·è¡¨ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º
```

**æ”¯å‡ºè®°å½•è¡¨ (expenses)**

```sql
CREATE TABLE expenses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    category_id UUID REFERENCES categories(id),
    amount DECIMAL(10,2) NOT NULL,
    description TEXT,
    expense_date DATE NOT NULL DEFAULT CURRENT_DATE,
    source VARCHAR(20) DEFAULT 'manual' CHECK (source IN ('manual', 'voice')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_expenses_user_id ON expenses(user_id);
CREATE INDEX idx_expenses_date ON expenses(expense_date DESC);
CREATE INDEX idx_expenses_category ON expenses(category_id);

-- æƒé™è®¾ç½®
GRANT SELECT ON expenses TO anon;
GRANT ALL PRIVILEGES ON expenses TO authenticated;
```

**åˆ†ç±»è¡¨ (categories)**

```sql
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    name VARCHAR(50) NOT NULL,
    icon VARCHAR(50) DEFAULT 'ğŸ’°',
    color VARCHAR(7) DEFAULT '#4CAF50',
    is_default BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_categories_user_id ON categories(user_id);

-- æƒé™è®¾ç½®
GRANT SELECT ON categories TO anon;
GRANT ALL PRIVILEGES ON categories TO authenticated;

-- åˆå§‹åŒ–é»˜è®¤åˆ†ç±»
INSERT INTO categories (name, icon, color, is_default) VALUES
('é¤é¥®', 'ğŸ½ï¸', '#FF9800', true),
('äº¤é€š', 'ğŸš—', '#2196F3', true),
('è´­ç‰©', 'ğŸ›’', '#E91E63', true),
('å¨±ä¹', 'ğŸ¬', '#9C27B0', true),
('åŒ»ç–—', 'ğŸ¥', '#F44336', true),
('æ•™è‚²', 'ğŸ“š', '#3F51B5', true),
('å…¶ä»–', 'ğŸ’°', '#607D8B', true);
```

**é¢„ç®—è¡¨ (budgets)**

```sql
CREATE TABLE budgets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    category_id UUID REFERENCES categories(id),
    amount DECIMAL(10,2) NOT NULL,
    period_type VARCHAR(10) NOT NULL CHECK (period_type IN ('weekly', 'monthly')),
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_budgets_user_id ON budgets(user_id);
CREATE INDEX idx_budgets_period ON budgets(start_date, end_date);

-- æƒé™è®¾ç½®
GRANT SELECT ON budgets TO anon;
GRAN
```

